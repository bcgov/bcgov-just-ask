name: On Deployment Created
on:
  push:
    branches:
      - main
env:
  OUTPUT_PATH: ${{ github.workspace }}/temp
jobs:
  deploy:
    name: Deploy Just ask
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v1
    
      - name: Cluster Login
        uses: redhat-developer/openshift-actions@v1.1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL }}
          parameters: '{"apitoken": "${{ secrets.OPENSHIFT_SA_PASSWORD }}"}'
          cmd: |
            'version'

      - name: Run Playbook
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          APP_ID: ${{ secrets.APP_ID }}
          DB_ADMIN_PASSWORD: ${{ secrets.DB_ADMIN_PASSWORD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
        run: >-
          ansible-playbook -i inventory/silver deploy.yaml \
          --extra-vars PRIVATE_KEY=$PRIVATE_KEY
          --extra-vars CLIENT_ID=$CLIENT_ID
          --extra-vars CLIENT_SECRET=$CLIENT_SECRET
          --extra-vars APP_ID=$APP_ID
          --extra-vars DB_ADMIN_PASSWORD=$DB_ADMIN_PASSWORD
          --extra-vars DB_PASSWORD=$DB_PASSWORD
          --extra-vars DB_NAME=$DB_NAME
          --extra-vars DB_USER=$DB_USER
          --extra-vars output_path=$OUTPUT_PATH
